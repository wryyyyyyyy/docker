name: Develop CI

on:
  push:
    branches:
    - develop

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2

#      - name: Setup
#        run: bash setup.sh

      - uses: azure/docker-login@v1
        with:
          login-server: ghcr.io
          username: ${GITHUB_REPOSITORY_OWNER}
          password: ${CONTAINER_TOKEN}

        name: Get busy
        run: |
          wget -c -q https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox -O image-0001/bin/busybox
          sudo chmod u+x image-0001/bin/busybox

        name: Build and push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          context: image-0001/
          file: image-0001/Dockerfile
          push: true
          tags: ${GITHUB_REPOSITORY_OWNER}/bussy:v1

        name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}


#      - run: |
#          mkdir image-0001/bin
#          wget -c -q https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox -O image-0001/bin/busybox
#          chmod u+x image-0001/bin/busybox
#          echo $CONTAINER_TOKEN | docker login ghcr.io -u $GITHUB_REPOSITORY_OWNER --password-stdin
#          export REGISTRY="ghcr.io"
#          export SOURCE_IMAGE="bussy"
#          export VERSION="v1"
#          docker build image-0001/ -t $SOURCE_IMAGE:$VERSION
#          sleep 2s
#          docker image ls $SOURCE_IMAGE:$VERSION
#          docker tag $SOURCE_IMAGE:$VERSION $REGISTRY/${GITHUB_REPOSITORY_OWNER}/$SOURCE_IMAGE:$VERSION
#          docker push $REGISTRY/${GITHUB_REPOSITORY_OWNER}/bussy:v1
